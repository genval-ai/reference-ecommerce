groups:
- name: DORA Metrics Alerts
  rules:

  - alert: LowDeploymentFrequency
    expr: rate(deployments_total[7d]) < 1/(7*24*3600)
    for: 1h
    labels:
      severity: warning
    annotations:
      summary: "Low deployment frequency detected"
      description: "Deployment frequency has dropped below once per week"

  - alert: HighLeadTime
    expr: avg(lead_time_seconds) > 604800  # 7 days in seconds
    for: 1d
    labels:
      severity: warning
    annotations:
      summary: "High lead time detected"
      description: "Average lead time for changes is over 7 days"

  - alert: HighMTTR
    expr: avg(mttr_seconds) > 3600  # 1 hour in seconds
    for: 1h
    labels:
      severity: critical
    annotations:
      summary: "High Mean Time to Recovery (MTTR) detected"
      description: "Average MTTR is over 1 hour"

  - alert: HighChangeFailureRate
    expr: sum(failed_deployments_total) / sum(deployments_total) > 0.15
    for: 1d
    labels:
      severity: critical
    annotations:
      summary: "High change failure rate detected"
      description: "Change failure rate is above 15%"

  - alert: DeploymentFrequencyDecreasing
    expr: rate(deployments_total[7d]) < rate(deployments_total[7d] offset 7d)
    for: 7d
    labels:
      severity: warning
    annotations:
      summary: "Deployment frequency is decreasing"
      description: "Deployment frequency has decreased compared to the previous week"

  - alert: LeadTimeIncreasing
    expr: avg_over_time(lead_time_seconds[7d]) > avg_over_time(lead_time_seconds[7d] offset 7d)
    for: 7d
    labels:
      severity: warning
    annotations:
      summary: "Lead time is increasing"
      description: "Average lead time has increased compared to the previous week"

  - alert: MTTRIncreasing
    expr: avg_over_time(mttr_seconds[7d]) > avg_over_time(mttr_seconds[7d] offset 7d)
    for: 7d
    labels:
      severity: warning
    annotations:
      summary: "MTTR is increasing"
      description: "Average MTTR has increased compared to the previous week"

  - alert: ChangeFailureRateIncreasing
    expr: sum(failed_deployments_total[7d]) / sum(deployments_total[7d]) > sum(failed_deployments_total[7d] offset 7d) / sum(deployments_total[7d] offset 7d)
    for: 7d
    labels:
      severity: warning
    annotations:
      summary: "Change failure rate is increasing"
      description: "Change failure rate has increased compared to the previous week"